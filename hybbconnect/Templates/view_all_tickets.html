{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container-fluid mt-3 px-3">

    <!-- üîπ Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-teal">üéü All Tickets</h3>
        <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">‚¨Ö Back</a>
    </div>

    <!-- üîç Filter Section -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">

                <!-- üè∑Ô∏è Status -->
                <div class="col-md-3">
                    <label class="form-label mb-1 fw-semibold text-muted">Status</label>
                    <select name="status" class="form-select">
                        <option value="">All</option>
                        <option value="Pending" {% if request.GET.status == "Pending" %}selected{% endif %}>Pending</option>
                        <option value="In Progress" {% if request.GET.status == "In Progress" %}selected{% endif %}>In Progress</option>
                        <option value="Resolved" {% if request.GET.status == "Resolved" %}selected{% endif %}>Resolved</option>
                        <option value="Closed" {% if request.GET.status == "Closed" %}selected{% endif %}>Closed</option>
                    </select>
                </div>

                <!-- üë®‚Äçüíº Owner -->
                <div class="col-md-3">
                    <label class="form-label mb-1 fw-semibold text-muted">Owner / Cluster Manager</label>
                    <select name="assigned_to" class="form-select">
                        <option value="">All</option>
                        {% for owner in owners %}
                            <option value="{{ owner.id }}" 
                                {% if request.GET.assigned_to == owner.id|stringformat:"s" %}selected{% endif %}>
                                {{ owner.username }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- üìç Location -->
                <div class="col-md-3">
                    <label class="form-label mb-1 fw-semibold text-muted">Location</label>
                    <select name="location" class="form-select">
                        <option value="">All</option>
                        {% for loc in locations %}
                            <option value="{{ loc.name }}" {% if request.GET.location == loc.name %}selected{% endif %}>
                                {{ loc.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- üîò Filter Button -->
                <div class="col-md-3">
                    <button type="submit" class="btn btn-teal w-100">Apply Filters</button>
                </div>
            </form>

            <!-- ‚¨áÔ∏è Download CSV Button -->
            <div class="d-flex justify-content-end mt-3">
                <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}download=csv"
                   class="btn btn-outline-success">
                    ‚¨áÔ∏è Download CSV
                </a>
            </div>
        </div>
    </div>
<div class="card shadow-sm border-0 w-100">
    <div class="card-body">
        <h5 class="fw-semibold text-muted mb-3">All Tickets</h5>

        <div class="table-responsive" style="max-height: 650px; overflow-y: auto;">
            <table class="table table-striped table-bordered align-middle table-sm">
                <thead class="table-light sticky-top">
                    <tr class="text-center">
                        <th style="min-width:120px;">Raised Date</th>
                        <th style="min-width:110px;">Ticket No</th>
                        <th style="min-width:140px;">Raised By Role</th>
                        <th style="min-width:150px;">Employee Name</th>
                        <th style="min-width:120px;">Emp Code</th>
                        <th style="min-width:140px;">Location</th>
                        <th style="min-width:150px;">Concern</th>
                        <th style="min-width:150px;">Category</th>
                        <th style="min-width:120px;">Status</th>
                        <th style="min-width:250px;">Description</th>
                        <th style="min-width:150px;">Owner</th>
                        <th style="min-width:150px;">Closed At</th>
                        <th style="min-width:120px;">Pending Days</th>
                        <th style="min-width:150px;">Confirm Date</th>
                        <th style="min-width:180px;">Confirm Pending Days</th>
                        <th style="min-width:180px;">Employee Remarks</th>
                        <th style="min-width:180px;">Owner Remarks</th>
                        <th style="min-width:180px;">Owner Closer Remarks</th>
                        <th style="min-width:180px;">Cluster Closer Remarks</th>
                        <th style="min-width:180px;">Rejection Remarks</th>
                        <th style="min-width:180px;">Reassigned Info</th>
                        <th style="min-width:150px;">Time to Resolve</th>
                        <th style="min-width:120px;">SLA</th>
                    </tr>
                </thead>

                <tbody>
                    {% for t in tickets %}
                    <tr>
                        <td>{{ t.created_at|date:"d M Y" }}</td>
                        <td><strong>{{ t.ticket_number }}</strong></td>

                        <!-- Raised By Role -->
                         <td class="text-center">

                    {% with role=t.employee.role %}
    
                            {% if role == 'kitchen_manager' %}
                                <span class="badge bg-teal">Kitchen Manager</span>

                            {% elif role == 'cluster_manager' %}
                                <span class="badge bg-dark">Cluster Manager</span>

                            {% elif role == 'kitchen_staff' %}
                                <span class="badge bg-primary">Kitchen Staff</span>

                            {% elif role == 'owner' %}
                                <span class="badge bg-purple">Owner</span>

                            {% elif role == 'admin' %}
                                <span class="badge bg-danger">Admin</span>

                            {% else %}
                                <span class="badge bg-secondary">Unknown</span>
                            {% endif %}

                        {% endwith %}

                    </td>
            


                        <td>{{ t.employee.username|default:"-" }}</td>
                        <td>{{ t.employee.employee_id|default:"-" }}</td>
                        <td>{{ t.location.name|default:"-" }}</td>
                        <td class="text-wrap">{{ t.concern|default:"-" }}</td>
                        <td class="text-wrap">{{ t.concern_category|default:"-" }}</td>

                        <!-- Status Badge -->
                        <td class="text-center">
                            {% if t.status == "Pending" %}
                                <span class="badge bg-warning text-dark">Pending</span>
                            {% elif t.status == "In Progress" %}
                                <span class="badge bg-info text-dark">In Progress</span>
                            {% elif t.status == "Resolved" %}
                                <span class="badge bg-success">Resolved</span>
                            {% elif t.status == "Closed" %}
                                <span class="badge bg-secondary">Closed</span>
                            {% else %}
                                <span class="badge bg-light text-dark">{{ t.status }}</span>
                            {% endif %}
                        </td>

                        <td class="text-wrap">{{ t.description }}</td>
                        <td>{{ t.assigned_owner.username|default:"-" }}</td>
                        <td>{{ t.closed_dt }}</td>
                        <td>{{ t.pending_days }}</td>
                        <td>{{ t.confirm_dt }}</td>
                        <td>{{ t.confirm_pending }}</td>
                        <td class="text-wrap">{{ t.employee_remarks }}</td>
                        <td class="text-wrap">{{ t.owner_remarks }}</td>
                        <td class="text-wrap">{{ t.owner_closer_remarks|default:"-" }}</td>
                        <td class="text-wrap">{{ t.cluster_closer_remarks|default:"-" }}</td>
                        <td class="text-wrap">{{ t.rejection_remarks }}</td>
                        <td class="text-wrap">{{ t.reassigned_info }}</td>
                        <td>{{ t.time_to_resolve }}</td>

                        <td class="text-center">
                            {% if t.sla_breach %}
                                <span class="badge bg-danger">YES</span>
                            {% else %}
                                <span class="badge bg-success">NO</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="21" class="text-center text-muted py-4">No tickets found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>

<style>
    .container-fluid { max-width: 100% !important; }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 6px;
        min-width: 90px;
        text-align: center;
    }

    th { white-space: nowrap; }
    .text-wrap { white-space: normal !important; }
    td { vertical-align: middle !important; }

    .btn-teal { background:#009688; color:white; }
    .btn-teal:hover { background:#00796b; }
</style>




{% endblock %}
